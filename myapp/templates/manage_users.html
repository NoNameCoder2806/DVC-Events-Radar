{% extends 'base.html' %}
{% block title %}Manage Users{% endblock %}

{% block page_title %}
<div class="page-header-title-wrapper">
    <button type="button" class="user-back-btn" id="backBtn">‚Üê Back</button>
    <span class="page-title">Manage Users</span>
</div>

<script>
document.getElementById('backBtn').addEventListener('click', function() {
    history.back();
});
</script>
{% endblock %}

{% block header_spacer2 %}
<div style="height: 30px;"></div>
{% endblock %}

{% block content %}
<!-- Top notification -->
<div id="topNotification" style="
    position: fixed;
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    z-index: 9999;
    transition: top 0.5s ease, opacity 0.5s ease;
    opacity: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
"></div>

<!-- Users Table -->
<div class="d-flex justify-content-center mt-5">
    <div class="w-75 user-table-wrapper">
        <div class="white-box">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>DVC ID</th>
                        <th>Email</th>
                        <th>Date Joined</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.users.DVC_ID }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                        <td class="role-text">{{ user.users.role }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary change-role-btn"
                                data-user-id="{{ user.id }}"
                                data-current-role="{{ user.users.role }}"
                                data-user-email="{{ user.username }}">
                                Role
                            </button>
                            <button class="btn btn-sm btn-danger delete-user-btn"
                                data-name="{{ user.username }}"
                                data-url="{% url 'delete_user' user.id %}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No users found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<form id="roleForm">
  {% csrf_token %}
  <div class="modal fade" id="roleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title">Change User Role</h5>
                  <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                  </button>
              </div>

              <div class="modal-body">
                  <p>Change role for <span id="roleUserEmail" class="font-weight-bold" style="color: #173F6C;"></span>:</p>
                  <select id="newRoleSelect" class="form-select mt-2">
                      <option value="user">User</option>
                      <option value="admin">Admin</option>
                      <option value="superuser">Superuser</option>
                  </select>
              </div>
              
              <div class="modal-footer d-flex gap-2">
                  <button type="button" class="btn btn-secondary flex-fill w-100" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary flex-fill w-100">Save</button>
              </div>
          </div>
      </div>
  </div>
</form>

<!-- Delete User Modal -->
<form method="POST" id="deleteForm">
    {% csrf_token %}
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete User</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <p>You are about to delete this user:</p>
                    <p class="font-weight-bold" id="deleteUserEmail" style="color: #173F6C;"></p>
                </div>

                <div class="modal-footer d-flex gap-2">
                    <!-- <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button> -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    
                    <form id="deleteForm" method="POST" class="flex-fill">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Styles (unchanged, can include your existing CSS) -->
<style>
body {
    padding-bottom: 100px !important;
}

/* Title */
.page-header-title-wrapper {
    position: relative;
    width: 100%;
    height: 80px;
}

.page-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 15%));
    font-weight: bold;
    font-size: 63px;
    color: #017550;
    white-space: nowrap;
}

/* Back button */
.user-back-btn {
    position: absolute;
    top: 16%;
    left: 0;
    margin-left: 10%;
    padding: 12px 20px;
    background: white;          /* white by default */
    color: #0a7a33;             /* green border/text */
    border: 2px solid #0a7a33; 
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.user-back-btn:hover {
    background-color: #0a7a33; /* fill green on hover */
    color: white;               /* text turns white */
    transform: translateY(-1px);
}

/* Remove all built-in table borders */
.table {
    border-collapse: separate !important;
    border-spacing: 0 15px !important;   /* spacing between row boxes */
}

/* Header as ONE single floating box */
.table thead {
    display: table-header-group;
}

.table thead tr {
    background: #ffffff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.10);
    border-radius: 12px;
}

/* Remove column separators + unify the surface */
.table thead th {
    background: transparent !important;
    border: none !important;
    padding: 18px;
    font-weight: 700;
    color: #173F6C;
    font-size: 20px;
}

/* Rounded corners on the entire header box */
.table thead th:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.table thead th:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

.table th, 
.table td {
    text-align: center !important;
    vertical-align: middle !important;
}

/* Row as floating card */
.table tbody tr {
    background: #ffffff !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.10);
    border-radius: 12px;
}

/* Make sure each cell has padding and no borders */
.table tbody td {
    font-size: 17px;
    border: none !important;
    padding: 18px;
    vertical-align: middle;
}

/* Rounded corners on each row */
.table tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.table tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* Hover colors for alternating rows */
/* Odd = dark green */
.table tbody tr:nth-child(odd):hover {
    background-color: #0A7A33 !important;
    color: white !important;
}

/* Even = dark blue */
.table tbody tr:nth-child(even):hover {
    background-color: #173F6C !important;
    color: white !important;
}

/* Buttons inside hovered rows stay readable */
.table tbody tr:hover .change-role-btn,
.table tbody tr:hover .delete-user-btn {
    filter: brightness(1.2);
}

.table-striped {
    border-top: none !important;
}

.change-role-btn {
    min-width: 75px !important;
    background-color: #017550 !important;  
    border-color: #017550 !important;
    color: white !important;
    font-weight: 600;
    font-size: 15px;
    border-radius: 6px;
}

.change-role-btn:hover {
    background-color: #015d41 !important;  /* slightly darker for hover */
    border-color: #015d41 !important;
}

.delete-user-btn {
    min-width: 75px !important;
    background-color: #DD1426 !important; /* red */
    border-color: #DD1426 !important;
    color: white !important;
    font-weight: bold;
    font-size: 15px;
    border-radius: 6px;
}

.delete-user-btn:hover {
    background-color: #B0101F !important; /* darker red */
    border-color: #B0101F !important;
}

.modal-header {
    background-color: #173F6C;  /* green to match the DVC theme */
    font-weight: bold;                      /* make header text bold */
    color: white;                           /* text color */
}

/* Modal header bold */
.modal-header .modal-title {
    font-weight: 700; /* bold */
}

/* Make modal footer buttons the same size */
.modal-footer {
    display: flex;
    gap: 12px;              /* spacing between buttons */
}

.modal-footer .btn {
    flex: 1;                /* make all buttons expand equally */
    border-radius: 25px;    /* pill-shaped ends */
    min-height: 45px;       /* optional: uniform height */
    font-weight: bold;
    font-size: 18px;
    outline: none !important;
    box-shadow: none !important; /* removes the default Bootstrap focus shadow */
}

/* Optional: also remove for table buttons */
.change-role-btn:focus,
.delete-user-btn:focus,
.user-back-btn:focus {
    outline: none !important;
    box-shadow: none !important;
}

/* Delete button */
.modal-footer .btn-danger {
    background-color: #FFFFFF;  /* white */
    border: 2px solid #017550;  /* green border */
    color: #017550;             /* green text */
}

.modal-footer .btn-danger:hover {
    background-color: #017550;  /* fill green on hover */
    color: #FFFFFF;             /* white text */
}

/* Cancel button */
.modal-footer .btn-secondary {
    background-color: #FFFFFF;  /* white */
    border: 2px solid #173F6C;  /* dark blue border */
    color: #173F6C;             /* dark blue text */
}

.modal-footer .btn-secondary:hover {
    background-color: #173F6C;  /* fill dark blue on hover */
    color: #FFFFFF;             /* white text */
}
/* Remove default modal background & spacing */
.modal-dialog {
    margin: auto;
    max-width: none;
    width: 30%;
    display: flex;
    align-items: center;        /* keep vertical centering */
    height: 100vh;
    padding: 0;
}

.modal-content {
    border-radius: 16px;      /* soft edges */
    border: none;             /* no default borders */
    background-color: #ffffff; /* the only visible rectangle */
    box-shadow: 0 6px 20px rgba(0,0,0,0.25); /* floating effect */
    overflow: hidden;
    margin-top: 10%;             /* move the modal down 10% from center */
}

/* Optional: remove padding around modal so only the content is visible */
.modal {
    padding: 0 !important;
}

/* Backdrop dim */
.modal-backdrop.show {
    opacity: 0.5; /* slightly dark background */
}

/* Header & Footer styling as before */
.modal-header {
    border-bottom: none;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
}

.modal-footer .btn {
    border-radius: 25px; /* pill-shaped ends */
}

.modal-header .close {
    color: white;           /* make the "√ó" white */
    opacity: 1;             /* remove any transparency */
    font-size: 1.5rem;      /* optional: make it bigger */
}

.modal-header .close:hover {
    color: #f8f8f8;         /* optional: slightly lighter on hover */
    opacity: 1;
}
</style>

<!-- Top Notification -->
<script>
function showTopMessage(text, type="info") {
    const box = document.getElementById("topNotification");
    const colors = { success:"#28a745", error:"#dc3545", warning:"#ffc107", info:"#17a2b8" };
    box.style.background = colors[type] || colors.info;
    box.textContent = text;
    box.style.transition = "none";
    box.style.top = "-80px";
    box.style.opacity = "0";
    void box.offsetWidth;
    box.style.transition = "top 0.5s ease, opacity 0.5s ease";
    box.style.top = "20px";
    box.style.opacity = "1";
    setTimeout(()=>{ box.style.top="-80px"; box.style.opacity="0"; }, 2500);
}
</script>

<script>
// ===== Change Role Modal =====
document.querySelectorAll(".change-role-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const userId = this.dataset.userId;
        const userEmail = this.dataset.userEmail;
        const currentRole = this.dataset.currentRole;

        const emailSpan = document.getElementById("roleUserEmail");
        const roleSelect = document.getElementById("newRoleSelect");
        const form = document.getElementById("roleForm");

        emailSpan.innerText = userEmail;

        roleSelect.value = currentRole;

        // ======================
        // Determine row & color
        // ======================
        const row = this.closest("tr");
        const index = Array.from(row.parentNode.children).indexOf(row);
        const mainColor = (index % 2 === 0) ? "#0A7A33" : "#173F6C"; // green / blue

        // ===== Elements =====
        const header = document.querySelector("#roleModal .modal-header");
        const saveBtn = document.querySelector("#roleModal .btn-primary");
        const cancelBtn = document.querySelector("#roleModal .btn-secondary");

        // ======================
        // Header color
        // ======================
        header.style.backgroundColor = mainColor;
        header.style.color = "white";
        header.style.setProperty("background-color", mainColor, "important");

        // ======================
        // Email text color
        // ======================
        emailSpan.style.color = mainColor;
        emailSpan.style.fontWeight = "bold";

        // ======================
        // Save button
        // ======================
        saveBtn.style.borderColor = mainColor;
        saveBtn.style.color = mainColor;
        saveBtn.style.backgroundColor = "#fff";

        saveBtn.onmouseenter = () => {
            saveBtn.style.backgroundColor = mainColor;
            saveBtn.style.color = "#fff";
        };
        saveBtn.onmouseleave = () => {
            saveBtn.style.backgroundColor = "#fff";
            saveBtn.style.color = mainColor;
        };

        // ======================
        // Cancel (always red)
        // ======================
        cancelBtn.style.borderColor = "#D31325";
        cancelBtn.style.color = "#D31325";
        cancelBtn.style.backgroundColor = "#fff";

        cancelBtn.onmouseenter = () => {
            cancelBtn.style.backgroundColor = "#D31325";
            cancelBtn.style.color = "#fff";
        };
        cancelBtn.onmouseleave = () => {
            cancelBtn.style.backgroundColor = "#fff";
            cancelBtn.style.color = "#D31325";
        };

        // ======================
        // Submit handler
        // ======================
        form.onsubmit = (e) => {
            e.preventDefault();
            const newRole = roleSelect.value;

            fetch("{% url 'change_user_role' 0 %}".replace('0', userId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ role: newRole })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    // Update table
                    const row = document.querySelector(`.change-role-btn[data-user-id="${userId}"]`).closest("tr");
                    row.querySelector(".role-text").innerText = newRole;

                    $('#roleModal').modal('hide');
                    showTopMessage("Role updated successfully!", "success");
                } else {
                    showTopMessage(`Error: ${data.message}`, "error");
                }
            })
            .catch(() => showTopMessage("An unexpected error occurred.", "error"));
        };

        // Open modal
        $('#roleModal').modal('show');
    });
});


// ===== Delete User Modal =====
document.querySelectorAll(".delete-user-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const url = this.dataset.url;
        const name = this.dataset.name;

        const row = this.closest("tr");
        const rowIndex = Array.from(row.parentNode.children).indexOf(row);

        const modalName = document.getElementById("deleteUserEmail");
        const modalHeader = document.querySelector("#deleteModal .modal-header");
        const cancelBtn = document.querySelector("#deleteModal .btn-secondary");
        const deleteBtn = document.querySelector("#deleteModal .btn-danger");

        // Set user name
        modalName.innerText = name;

        // Odd / even row colors
        const mainColor = (rowIndex % 2 === 0) ? "#0A7A33" : "#173F6C";
        modalName.style.color = mainColor;
        
        const red = "#DD1426";
        modalHeader.style.setProperty("background-color", red, "important");        cancelBtn.style.borderColor = mainColor;
        
        // Cancel button hover
        cancelBtn.style.borderColor = mainColor;
        cancelBtn.style.color = mainColor;
        cancelBtn.onmouseenter = () => {
            cancelBtn.style.backgroundColor = mainColor;
            cancelBtn.style.color = "#fff";
        };
        cancelBtn.onmouseleave = () => {
            cancelBtn.style.backgroundColor = "#fff";
            cancelBtn.style.color = mainColor;
        };

        // Delete button always red
        deleteBtn.style.borderColor = "#DD1426";
        deleteBtn.style.color = "#DD1426";
        deleteBtn.style.backgroundColor = "#fff";
        deleteBtn.onmouseenter = () => {
            deleteBtn.style.backgroundColor = "#DD1426";
            deleteBtn.style.color = "#fff";
        };
        deleteBtn.onmouseleave = () => {
            deleteBtn.style.backgroundColor = "#fff";
            deleteBtn.style.color = "#DD1426";
        };

        // Set form action
        document.getElementById("deleteForm").action = url;

        // Show modal
        $('#deleteModal').modal('show');
    });
});
</script>

<!-- üî• Trigger messages ONLY on this page -->
{% for message in messages %}
<script>
showTopMessage("{{ message|escapejs }}", "{{ message.tags }}");
</script>
{% endfor %}
{% endblock %}
