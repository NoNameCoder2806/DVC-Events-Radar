{% extends 'base.html' %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<div id="topNotification" style="
    position: fixed;
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    z-index: 9999;
    transition: top 0.5s ease, opacity 0.5s ease;
    opacity: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
"></div>

<div class="d-flex justify-content-center mt-5">
    <div class="w-75">

        <!-- Top bar with back button -->
        <div class="d-flex align-items-center mb-4 position-relative">
            <div class="position-absolute" style="left: 0;">
                <a href="{% url 'home' %}" class="btn btn-secondary">&larr; Back</a>
            </div>
            <h2 class="mx-auto text-center">Manage Users</h2>
        </div>

        <!-- Users table -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Date Joined</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in all_users %}
                <tr id="user-row-{{ user.id }}">
                    <td>{{ user.email }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                    <td class="role-text">{{ user.users.role }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary change-role-btn"
                            data-user-id="{{ user.id }}"
                            data-current-role="{{ user.users.role }}">
                            Change Role
                        </button>
                        <button class="btn btn-sm btn-danger delete-user-btn"
                            data-user-id="{{ user.id }}">
                            Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</div>

<!-- CHANGE ROLE MODAL -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Change User Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Change role for <span id="roleUserEmail"></span>:</p>
                <select id="newRoleSelect" class="form-select">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="superuser">Superuser</option>
                </select>
            </div>
            <div class="modal-footer d-flex gap-2">
                <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary flex-fill" id="saveRoleBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- DELETE USER MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user: <span id="deleteUserEmail"></span>?</p>
            </div>
            <div class="modal-footer d-flex gap-2">
                <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger flex-fill" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS Bundle (needs to be BEFORE your script) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let selectedUserId = null;
    let selectedUserEmail = null;

    const roleModalEl = document.getElementById('roleModal');
    const roleModal = new bootstrap.Modal(roleModalEl);

    const deleteModalEl = document.getElementById('deleteModal');
    const deleteModal = new bootstrap.Modal(deleteModalEl);

    function showTopMessage(text, type="info") {
        const box = document.getElementById("topNotification");
        const colors = { success:"#28a745", error:"#dc3545", warning:"#ffc107", info:"#17a2b8" };
        box.style.background = colors[type] || colors.info;
        box.textContent = text;
        box.style.transition = "none";
        box.style.top = "-80px";
        box.style.opacity = "0";
        void box.offsetWidth;
        box.style.transition = "top 0.5s ease, opacity 0.5s ease";
        box.style.top = "20px";
        box.style.opacity = "1";
        setTimeout(()=>{ box.style.top="-80px"; box.style.opacity="0"; }, 2500);
    }

    // ===== Change Role Button =====
    document.querySelectorAll(".change-role-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            selectedUserId = this.dataset.userId;
            selectedUserEmail = this.closest('tr').querySelector('td').innerText;
            document.getElementById("roleUserEmail").innerText = selectedUserEmail;
            document.getElementById("newRoleSelect").value = this.dataset.currentRole;
            roleModal.show();
        });
    });

    document.getElementById("saveRoleBtn").addEventListener("click", function() {
        const newRole = document.getElementById("newRoleSelect").value;
        fetch("{% url 'change_user_role' 0 %}".replace('0', selectedUserId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ role: newRole })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                document.querySelector(`#user-row-${selectedUserId} .role-text`).innerText = newRole;
                roleModal.hide();
                showTopMessage("Role updated successfully!", "success");
            } else {
                showTopMessage(`Error: ${data.message}`, "error");
            }
        });
    });

    // ===== Delete User Button =====
    document.querySelectorAll(".delete-user-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            selectedUserId = this.dataset.userId;
            selectedUserEmail = this.closest('tr').querySelector('td').innerText;
            document.getElementById("deleteUserEmail").innerText = selectedUserEmail;
            deleteModal.show();
        });
    });

    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
        fetch("{% url 'delete_user' 0 %}".replace('0', selectedUserId), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                document.getElementById(`user-row-${selectedUserId}`).remove();
                deleteModal.hide();
                showTopMessage("User deleted successfully!", "success");
            } else {
                showTopMessage(`Error: ${data.message}`, "error");
            }
        });
    });
});
</script>

{% endblock %}
