{% extends 'base.html' %}
{% block title %}Manage Users{% endblock %}

{% block page_title %}
<div class="page-header-title-wrapper">
    <button type="button" class="user-back-btn" id="backBtn">‚Üê Home</button>

    <span class="page-title">Manage Users</span>
</div>

<script>
document.getElementById('backBtn').addEventListener('click', function() {
    window.location.href = "{% url 'home' %}";
});
</script>
{% endblock %}

{% block header_spacer2 %}
<div style="height: 30px;"></div>
{% endblock %}

{% block content %}
<div id="topNotification" style="
    position: fixed;
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    z-index: 9999;
    transition: top 0.5s ease, opacity 0.5s ease;
    opacity: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
"></div>

<div class="d-flex justify-content-center mt-5">
    <div class="w-75 user-table-wrapper">
        <div class="white-box">
            <!-- Users table -->
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>DVC ID</th>
                        <th>Email</th>
                        <th>Date Joined</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_users %}
                    <tr id="user-row-{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td>{{ user.users.DVC_ID }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                        <td class="role-text">{{ user.users.role }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary change-role-btn"
                                data-user-id="{{ user.id }}"
                                data-current-role="{{ user.users.role }}">
                                Edit Role
                            </button>
                            <button class="btn btn-sm btn-danger delete-user-btn"
                                data-user-id="{{ user.id }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No users found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- CHANGE ROLE MODAL -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Change User Role</h5>
        <!-- Use btn-close-white for dark header -->
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Change role for <span id="roleUserEmail"></span>:</p>
        <select id="newRoleSelect" class="form-select">
          <option value="user">User</option>
          <option value="admin">Admin</option>
          <option value="superuser">Superuser</option>
        </select>
      </div>
      <div class="modal-footer d-flex gap-2">
        <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary flex-fill" id="saveRoleBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- DELETE USER MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Delete User</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete user: <span id="deleteUserEmail"></span>?</p>
      </div>
      <div class="modal-footer d-flex gap-2">
        <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger flex-fill" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<style>
body {
    padding-bottom: 100px !important;
}

/* Title */
.page-header-title-wrapper {
    position: relative;
    width: 100%;
    height: 80px;
}

.page-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 15%));
    font-weight: bold;
    font-size: 63px;
    color: #017550;
    white-space: nowrap;
}

/* Back button */
.user-back-btn {
    position: absolute;
    top: 16%;
    left: 0;
    margin-left: 10%;
    padding: 12px 20px;
    background: white;          /* white by default */
    color: #0a7a33;             /* green border/text */
    border: 2px solid #0a7a33; 
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.user-back-btn:hover {
    background-color: #0a7a33; /* fill green on hover */
    color: white;               /* text turns white */
    transform: translateY(-1px);
}

/* Remove all built-in table borders */
.table {
    border-collapse: separate !important;
    border-spacing: 0 15px !important;   /* spacing between row boxes */
}

/* Header as ONE single floating box */
.table thead {
    display: table-header-group;
}

.table thead tr {
    background: #ffffff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.10);
    border-radius: 12px;
}

/* Remove column separators + unify the surface */
.table thead th {
    background: transparent !important;
    border: none !important;
    padding: 18px;
    font-weight: 700;
    color: #173F6C;
    font-size: 20px;
}

/* Rounded corners on the entire header box */
.table thead th:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.table thead th:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

.table th, 
.table td {
    text-align: center !important;
    vertical-align: middle !important;
}

/* Row as floating card */
.table tbody tr {
    background: #ffffff !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.10);
    border-radius: 12px;
}

/* Make sure each cell has padding and no borders */
.table tbody td {
    font-size: 17px;
    border: none !important;
    padding: 18px;
    vertical-align: middle;
}

/* Rounded corners on each row */
.table tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.table tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* Hover colors for alternating rows */
/* Odd = dark green */
.table tbody tr:nth-child(odd):hover {
    background-color: #0A7A33 !important;
    color: white !important;
}

/* Even = dark blue */
.table tbody tr:nth-child(even):hover {
    background-color: #173F6C !important;
    color: white !important;
}

/* Buttons inside hovered rows stay readable */
.table tbody tr:hover .change-role-btn,
.table tbody tr:hover .delete-user-btn {
    filter: brightness(1.2);
}

.table-striped {
    border-top: none !important;
}

.change-role-btn {
    min-width: 75px !important;
    background-color: #017550 !important;  
    border-color: #017550 !important;
    color: white !important;
    font-weight: 600;
    font-size: 15px;
    border-radius: 6px;
}

.change-role-btn:hover {
    background-color: #015d41 !important;  /* slightly darker for hover */
    border-color: #015d41 !important;
}

.delete-user-btn {
    min-width: 75px !important;
    background-color: #DD1426 !important; /* red */
    border-color: #DD1426 !important;
    color: white !important;
    font-weight: bold;
    font-size: 15px;
    border-radius: 6px;
}

.delete-user-btn:hover {
    background-color: #B0101F !important; /* darker red */
    border-color: #B0101F !important;
}
</style>

<!-- Bootstrap 5 JS Bundle (needs to be BEFORE your script) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let selectedUserId = null;
    let selectedUserEmail = null;

    const roleModalEl = document.getElementById('roleModal');
    const roleModal = new bootstrap.Modal(roleModalEl);

    const deleteModalEl = document.getElementById('deleteModal');
    const deleteModal = new bootstrap.Modal(deleteModalEl);

    function showTopMessage(text, type="info") {
        const box = document.getElementById("topNotification");
        const colors = { success:"#28a745", error:"#dc3545", warning:"#ffc107", info:"#17a2b8" };
        box.style.background = colors[type] || colors.info;
        box.textContent = text;
        box.style.transition = "none";
        box.style.top = "-80px";
        box.style.opacity = "0";
        void box.offsetWidth;
        box.style.transition = "top 0.5s ease, opacity 0.5s ease";
        box.style.top = "20px";
        box.style.opacity = "1";
        setTimeout(()=>{ box.style.top="-80px"; box.style.opacity="0"; }, 2500);
    }

    // ===== Change Role Button =====
    document.querySelectorAll(".change-role-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            selectedUserId = this.dataset.userId;
            selectedUserEmail = this.closest('tr').querySelector('td').innerText;
            document.getElementById("roleUserEmail").innerText = selectedUserEmail;
            document.getElementById("newRoleSelect").value = this.dataset.currentRole;
            roleModal.show();
        });
    });

    document.getElementById("saveRoleBtn").addEventListener("click", function() {
        const newRole = document.getElementById("newRoleSelect").value;
        fetch("{% url 'change_user_role' 0 %}".replace('0', selectedUserId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ role: newRole })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                document.querySelector(`#user-row-${selectedUserId} .role-text`).innerText = newRole;
                roleModal.hide();
                showTopMessage("Role updated successfully!", "success");
            } else {
                showTopMessage(`Error: ${data.message}`, "error");
            }
        });
    });

    // ===== Delete User Button =====
    document.querySelectorAll(".delete-user-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            selectedUserId = this.dataset.userId;
            selectedUserEmail = this.closest('tr').querySelector('td').innerText;
            document.getElementById("deleteUserEmail").innerText = selectedUserEmail;
            deleteModal.show();
        });
    });

    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
        fetch("{% url 'delete_user' 0 %}".replace('0', selectedUserId), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                document.getElementById(`user-row-${selectedUserId}`).remove();
                deleteModal.hide();
                showTopMessage("User deleted successfully!", "success");
            } else {
                showTopMessage(`Error: ${data.message}`, "error");
            }
        });
    });
});
</script>
{% endblock %}
