{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Top slide-down alert -->
<div id="top-alert" class="alert" role="alert" style="position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            z-index: 1050; width: auto; max-width: 400px; transition: top 0.5s ease, opacity 0.5s ease; opacity: 0;">
    <span id="top-alert-message"></span>
    <button type="button" class="close" onclick="hideAlert()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- üß≠ Left Column -->
<!-- sh-branch -->
        <div class="col-12 col-md-2">
            <h5 class="mb-3">Filters</h5>
      
            <form method="get">
                {% for field in form %}
                    <div class="border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between align-items-center>
                            <span class="fw-bold">{{ field.label }}</span>
                            <button class="btn btn-sm btn-outline-secondary toggle-btn" type="button" data-toggle="collapse" data-target="#{{ field.name }}Filter">
                            +
                            </button>
                        </div>
                        
                        <div class="collapse mt-2" id="{{ field.name}}Filter">
                            {{ field }}
                        </div>
                    </div>
                {% endfor %}
<!-- separator -->
        <div class="col-12 col-md-2">
            <h5 class="mb-3">Filters</h5>
            <!-- üìç Location -->
            <div class="border-bottom mb-2 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Location</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-btn collapsed" type="button" data-toggle="collapse"
                        data-target="#locationFilter" aria-expanded="false" aria-controls="locationFilter">
                        +
                    </button>
                </div>
                <div class="collapse mt-2" id="locationFilter">
                    <label class="form-check" for="onCampus">Pleasant Hill Campus<input type="checkbox" id="onCampus"><span class="checkmark"></span></label>
                    <label class="form-check" for="offCampus">San Ramon Campus<input type="checkbox" id="offCampus"><span class="checkmark"></span></label>
                    <label class="form-check" for="virtual">Virtual<input type="checkbox" id="virtual"><span class="checkmark"></span></label>
                </div>
            </div>

            <!-- üìÖ Select Days -->
            <div class="border-bottom mb-2 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Select Days</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-btn collapsed" type="button" data-toggle="collapse"
                        data-target="#daysFilter" aria-expanded="false" aria-controls="daysFilter">
                        +
                    </button>
                </div>
                <div class="collapse mt-2" id="daysFilter">
                      <label class="form-check" for="monday"><input class="form-check-input" type="checkbox" id="monday">Monday<span class="checkmark"></span></label>
                      <label class="form-check" for="tuesday"><input class="form-check-input" type="checkbox" id="tuesday">Tuesday<span class="checkmark"></span></label>
                      <label class="form-check" for="wednesday"><input class="form-check-input" type="checkbox" id="wednesday">Wednesday<span class="checkmark"></span></label>
                      <label class="form-check" for="thursday"><input class="form-check-input" type="checkbox" id="thursday">Thursday<span class="checkmark"></span></label>
                      <label class="form-check" for="friday"><input class="form-check-input" type="checkbox" id="friday">Friday<span class="checkmark"></span></label>
                  </div>
            </div>

            <!-- üïí Time Range -->
            <div class="border-bottom mb-2 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Select Time Range</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-btn collapsed" type="button" data-toggle="collapse"
                        data-target="#timeFilter" aria-expanded="false" aria-controls="timeFilter">
                        +
                    </button>
                </div>
                <div class="collapse mt-2" id="timeFilter">
                    <label class="form-check" for="morning"><input class="form-check-input" type="checkbox" id="morning">Morning<br>(8am‚Äì12pm)<span class="checkmark"></span></label>
                    <label class="form-check" for="afternoon"><input class="form-check-input" type="checkbox" id="afternoon">Afternoon<br>(12pm‚Äì5pm)<span class="checkmark"></span></label>
                    <label class="form-check" for="evening"><input class="form-check-input" type="checkbox" id="evening">Evening<br>(5pm‚Äì9pm)<span class="checkmark"></span></label>            
                </div>
            </div>

            <!-- üéüÔ∏è Event Type -->
            <div class="border-bottom mb-2 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Event Type</span>
                    <button class="btn btn-sm btn-outline-secondary toggle-btn collapsed" type="button" data-toggle="collapse"
                        data-target="#typeFilter" aria-expanded="false" aria-controls="typeFilter">
                        +
                    </button>
                </div>
                <div class="collapse mt-2" id="typeFilter">
                    <label class="form-check" for="sports"><input class="form-check-input" type="checkbox" id="sports">Sports<span class="checkmark"></span></label>
                    <label class="form-check" for="music"><input class="form-check-input" type="checkbox" id="music">Clubs<span class="checkmark"></span></label>
                    <label class="form-check" for="clubs">Career & Academic<input class="form-check-input" type="checkbox" id="clubs"><span class="checkmark"></span></label>
                    <label class="form-check" for="academic"><input class="form-check-input" type="checkbox" id="academic">Free Food<span class="checkmark"></span></label>
                </div>
            </div>
<!-- master -->

                <!-- Apply Button -->
                <button class="btn btn-primary w-100 mt-2">Apply Filters</button>
            </form>
        </div>

        <!-- üéüÔ∏è Middle Column -->
        <div class="col-12 col-md-8">
            <!-- Short Description -->
            <div>
                <p class="page-description">Add the Events page description here</p>
            </div>

            <!-- The Events Search Bar-->
            <div class="p-3 bg-white border rounded mb-3">
                <h3>Event Search</h3>

                <!-- Search form (functional with icon) -->
                <form method="get" action="{% url 'home' %}" class="d-flex align-items-center mb-3">
                    <input 
                        id="search-input"
                        type="text"
                        name="q"
                        class="form-control me-2"
                        placeholder="Search for events..."
                        value="{{ search_query|default:'' }}"
                    >
                    <button type="submit" class="btn btn-outline-secondary">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </form>

                <!-- ‚úÖ Events grid -->
                <div class="row">
                    {% for event in events_data %}
                    <div class="col-md-6 mb-4">
                        {% include 'partials/event_card.html' with event=event user_favorites=user_favorites %}
                    </div>
                    {% endfor %}
                </div>
            </div>


                <!-- Pagination Controls -->
                <nav aria-label="Event pagination">
                    <ul class="pagination justify-content-center mt-4">
                        {% if events_data.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ events_data.previous_page_number }}">&#8592;
                                Previous</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&#8592; Previous</span>
                        </li>
                        {% endif %}

                        {% for num in events_data.paginator.page_range %}
                        {% if events_data.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if events_data.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ events_data.next_page_number }}">Next &#8594;</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next &#8594;</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>


        <!-- üìÖ Right Column -->

        <div class="col-12 col-md-2">
            <div class="p-3 bg-light border rounded d-flex flex-column align-items-center">
                <h5>Quick Access</h5>
                {% if user_role in "admin superuser" %}
                <div class="mb-2 w-100 d-flex flex-column gap-2">
                    <a href="{% url 'add_event' %}" class="btn btn-primary w-100">Add Event</a>
                    <a href="{% url 'manage_events' %}" class="btn btn-warning w-100">Manage Events</a>
                </div>
                {% endif %}
                <a href="{% url 'calendar' %}" class="btn btn-primary mb-2 w-100">Full Calendar</a>
                <a href="{% url 'map' %}" class="btn btn-success w-100">Event Map</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Scripts -->
<script>
    // Change + to - when the filter is expanded
    document.querySelectorAll('.toggle-btn').forEach(button => {
        button.addEventListener('click', () => {
            const target = document.querySelector(button.dataset.target);
            const expanded = button.getAttribute('aria-expanded') === 'true';
            setTimeout(() => {
                button.textContent = expanded ? '+' : '‚àí';
            }, 150);
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.interested-btn');
        const alertDiv = document.getElementById('top-alert');
        const alertMessage = document.getElementById('top-alert-message');

        function showAlert(message, type = 'info') {
            alertDiv.className = `alert alert-${type}`;
            alertMessage.textContent = message;

            // Reset position instantly to hidden (no animation)
            alertDiv.style.transition = 'none';
            alertDiv.style.top = '-60px';
            alertDiv.style.opacity = '0';

            // Force browser to reflow so transition will work
            void alertDiv.offsetWidth;

            // Restore transition
            alertDiv.style.transition = 'top 0.5s ease, opacity 0.5s ease';

            // Slide down
            alertDiv.style.top = '20px';
            alertDiv.style.opacity = '1';

            // Clear any existing timer
            if (alertDiv.hideTimeout) {
                clearTimeout(alertDiv.hideTimeout);
            }

            // Auto-hide after 3 seconds
            alertDiv.hideTimeout = setTimeout(() => {
                hideAlert();
            }, 3000);
        }

        window.hideAlert = function () {
            alertDiv.style.top = '-60px';
            alertDiv.style.opacity = '0';
        };

        buttons.forEach(button => {
            button.addEventListener('click', async () => {
                const eventId = button.dataset.eventId;
                const csrfToken = '{{ csrf_token }}';

                try {
                    const response = await fetch(`/favorite/${eventId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.status === 'error') {
                        showAlert("‚ö†Ô∏è Please log in to mark an event as interested.", 'warning');
                        return;
                    }

                    if (data.status === 'added') {
                        button.textContent = 'Unmark ‚≠ê';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-success');
                        showAlert("‚≠ê Added to your interested events!", 'success');
                    } else if (data.status === 'removed') {
                        button.textContent = 'Interested ‚≠ê';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-warning');
                        showAlert("‚ùå Removed from your interested events.", 'info');
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("JS Loaded!");

    const buttons = document.querySelectorAll('.interested-btn');
    console.log("Found buttons:", buttons.length);
});
</script>

<script>
function showTopMessage(text, type = "info") {
    const box = document.getElementById("topNotification");

    const colors = {
        success: "#28a745",
        error: "#dc3545",
        warning: "#ffc107",
        info: "#17a2b8"
    };
    box.textContent = text;
    box.style.background = colors[type] || colors.info;

    // Reset instantly
    box.style.transition = "none";
    box.style.top = "-80px";
    box.style.opacity = "0";
    void box.offsetWidth; // force reflow

    // Apply transition
    box.style.transition = "top 0.5s ease, opacity 0.5s ease";

    // Tiny delay ensures smooth slide
    setTimeout(() => {
        box.style.top = "20px";
        box.style.opacity = "1";
    }, 50);

    // Auto-hide
    setTimeout(() => {
        box.style.top = "-80px";
        box.style.opacity = "0";
    }, 2600);
}
</script>

{% for message in messages %}
<script>
showTopMessage("{{ message|escapejs }}", "{{ message.tags }}");
</script>
{% endfor %}
{% endblock %}