{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Top slide-down alert -->
<div id="top-alert" class="alert" role="alert" style="position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            z-index: 1050; width: auto; max-width: 400px; transition: top 0.5s ease, opacity 0.5s ease; opacity: 0;">
    <span id="top-alert-message"></span>
    <button type="button" class="close" onclick="hideAlert()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- üß≠ Left Column -->
        <!-- sh-branch -->
        <div class="col-12 col-md-2">
            <h5 class="mb-3">Filters</h5>
      
            <form id="filterForm" onsubmit="return false;">
                {% for field in form %}
                    <div class="border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ field.label }}</span>
                            <button class="btn btn-sm btn-outline-secondary toggle-btn collapsed" type="button" data-toggle="collapse"
                                data-target="#{{ field.name }}Filter" aria-expanded="false" aria-controls="locationFilter">
                                +
                            </button>
                        </div>
                        
                        <div class="collapse mt-2" id="{{ field.name }}Filter">
                            {% for checkbox in field %}
                                <label class="form-check">
                                <input 
                                    type="checkbox"
                                    name="{{ field.name }}"
                                    value="{{ checkbox.data.value }}"
                                    id="{{ checkbox.id_for_label }}"
                                    class="filter-checkbox"
                                    {% if checkbox.data.selected %}
                                        checked
                                    {% endif %}
                                >
                                {{ checkbox.choice_label }}
                                <span class="checkmark"></span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </form>
        </div>

        <!-- üéüÔ∏è Middle Column -->
        <div class="col-12 col-md-8">
            <!-- Short Description -->
            <div>
                <p class="page-description">Add the Events page description here</p>
            </div>

            <!-- The Events Search Bar-->
            <div class="p-3 bg-white border rounded mb-3">
                <h3>Event Search</h3>

                <!-- Search form (functional with icon) -->
                <form method="get" action="{% url 'home' %}" class="d-flex align-items-center mb-3">
                    <input 
                        id="search-input"
                        type="text"
                        name="q"
                        class="form-control me-2"
                        placeholder="Search for events..."
                        value="{{ search_query|default:'' }}"
                    >
                    <button type="submit" class="btn btn-outline-secondary">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </form>

                <!-- ‚úÖ Events grid -->
                <div id="events-grid" class="row">
                    {% for event in events_data %}
                    <div class="col-md-6 mb-4">
                        {% include 'partials/event_card.html' with event=event user_favorites=user_favorites %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination Controls -->
                <nav id="pagination" aria-label="Event pagination">
                    <ul class="pagination justify-content-center mt-4">
                        {% if events_data.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ events_data.previous_page_number }}">&#8592; Previous</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">&#8592; Previous</span></li>
                        {% endif %}

                        {% for num in events_data.paginator.page_range %}
                            {% if events_data.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if events_data.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ events_data.next_page_number }}">Next &#8594;</a></li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">Next &#8594;</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>

         <!-- üìÖ Right Column -->
        <div class="col-12 col-md-2">
            <div class="p-3 bg-light border rounded d-flex flex-column align-items-center">
                <h5>Quick Access</h5>
                <!-- Manage Users Button -->
                {% if user_role == "superuser" %}
                <a href="{% url 'manage_users' %}" class="btn btn-warning mb-2 w-100">
                    üîê Manage Users
                </a>
                {% endif %}

                <!-- Add Event Button -->
                {% if user_role == "admin" or user_role == "superuser" %}
                <a href="{% url 'add_event' %}" class="btn btn-warning mb-2 w-100">
                    ‚ûï Add Event
                </a>

                <!-- Manage Events Button -->
                <a href="{% url 'manage_events' %}" class="btn btn-warning mb-2 w-100">
                    üõ†Ô∏è Manage Events
                </a>
                {% endif %}

                <!-- Quick Access Buttons -->
                <a href="{% url 'calendar' %}" class="btn btn-primary mb-2 w-100">üìÖ Full Calendar</a>
                <a href="{% url 'map' %}" class="btn btn-success w-100">üó∫Ô∏è Event Map</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Scripts -->
<script>
    // Change + to - when the filter is expanded
    document.querySelectorAll('.toggle-btn').forEach(button => {
        button.addEventListener('click', () => {
            const target = document.querySelector(button.dataset.target);
            const expanded = button.getAttribute('aria-expanded') === 'true';
            setTimeout(() => {
                button.textContent = expanded ? '+' : '‚àí';
            }, 150);
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.interested-btn');
        const alertDiv = document.getElementById('top-alert');
        const alertMessage = document.getElementById('top-alert-message');

        function showAlert(message, type = 'info') {
            alertDiv.className = `alert alert-${type}`;
            alertMessage.textContent = message;

            // Reset position instantly to hidden (no animation)
            alertDiv.style.transition = 'none';
            alertDiv.style.top = '-60px';
            alertDiv.style.opacity = '0';

            // Force browser to reflow so transition will work
            void alertDiv.offsetWidth;

            // Restore transition
            alertDiv.style.transition = 'top 0.5s ease, opacity 0.5s ease';

            // Slide down
            alertDiv.style.top = '20px';
            alertDiv.style.opacity = '1';

            // Clear any existing timer
            if (alertDiv.hideTimeout) {
                clearTimeout(alertDiv.hideTimeout);
            }

            // Auto-hide after 3 seconds
            alertDiv.hideTimeout = setTimeout(() => {
                hideAlert();
            }, 3000);
        }

        window.hideAlert = function () {
            alertDiv.style.top = '-60px';
            alertDiv.style.opacity = '0';
        };

        buttons.forEach(button => {
            button.addEventListener('click', async () => {
                const eventId = button.dataset.eventId;
                const csrfToken = '{{ csrf_token }}';

                try {
                    const response = await fetch(`/favorite/${eventId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.status === 'error') {
                        showAlert("‚ö†Ô∏è Please log in to mark an event as interested.", 'warning');
                        return;
                    }

                    if (data.status === 'added') {
                        button.textContent = 'Unmark ‚≠ê';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-success');
                        showAlert("‚≠ê Added to your interested events!", 'success');
                    } else if (data.status === 'removed') {
                        button.textContent = 'Interested ‚≠ê';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-warning');
                        showAlert("‚ùå Removed from your interested events.", 'info');
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("JS Loaded!");

    const buttons = document.querySelectorAll('.interested-btn');
    console.log("Found buttons:", buttons.length);
});
</script>

<script>
function showTopMessage(text, type = "info") {
    const box = document.getElementById("topNotification");

    const colors = {
        success: "#28a745",
        error: "#dc3545",
        warning: "#ffc107",
        info: "#17a2b8"
    };
    box.textContent = text;
    box.style.background = colors[type] || colors.info;

    // Reset instantly
    box.style.transition = "none";
    box.style.top = "-80px";
    box.style.opacity = "0";
    void box.offsetWidth; // force reflow

    // Apply transition
    box.style.transition = "top 0.5s ease, opacity 0.5s ease";

    // Tiny delay ensures smooth slide
    setTimeout(() => {
        box.style.top = "20px";
        box.style.opacity = "1";
    }, 50);

    // Auto-hide
    setTimeout(() => {
        box.style.top = "-80px";
        box.style.opacity = "0";
    }, 2600);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const filterForm = document.getElementById("filterForm");
    const searchInput = document.getElementById("search-input");

    // -----------------------------
    // Build params & fetch results
    // -----------------------------
    function applyFilters(page = null) {
        const params = new URLSearchParams();

        // all checked filters
        filterForm.querySelectorAll(".filter-checkbox:checked").forEach(cb => {
            params.append(cb.name, cb.value);
        });

        // search query
        if (searchInput && searchInput.value.trim()) {
            params.append("q", searchInput.value.trim());
        }

        // page number
        if (page) params.append("page", page);

        fetch("/?" + params.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(r => r.text())
            .then(html => {
                const doc = new DOMParser().parseFromString(html, "text/html");

                // update events grid
                const newGrid = doc.querySelector("#events-grid");
                const oldGrid = document.querySelector("#events-grid");
                if (newGrid && oldGrid) oldGrid.innerHTML = newGrid.innerHTML;

                // update pagination
                const newPag = doc.querySelector("#pagination");
                const oldPag = document.querySelector("#pagination");
                if (newPag && oldPag) oldPag.innerHTML = newPag.innerHTML;

                // re-bind pagination
                bindPaginationLinks();
            });
    }

    // -----------------------------
    // Checkbox change listener
    // -----------------------------
    filterForm.addEventListener("change", e => {
        if (e.target.classList.contains("filter-checkbox")) {
            applyFilters();
        }
    });

    // -----------------------------
    // Instant search (with delay)
    // -----------------------------
    let typingTimer;
    const typingDelay = 500; // ms

    if (searchInput) {
        searchInput.addEventListener("input", () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => applyFilters(), typingDelay);
        });
    }

    // -----------------------------
    // Pagination links
    // -----------------------------
    function bindPaginationLinks() {
        document.querySelectorAll("#pagination a.page-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                const page = link.getAttribute("href").split("page=")[1];
                applyFilters(page);
            });
        });
    }

    // Initial bind
    bindPaginationLinks();
});
</script>

{% for message in messages %}
<script>
showTopMessage("{{ message|escapejs }}", "{{ message.tags }}");
</script>
{% endfor %}
{% endblock %}