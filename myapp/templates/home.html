{% extends "base.html" %}
{% load static %}

{% block page_title %}
    <span class="page-title">Events</span>
{% endblock %}

{% block quick_access %}
<div class="quick-access-buttons d-flex flex-wrap align-items-center">
    {% if user_role == "superuser" %}
    <a href="{% url 'manage_users' %}" class="qa-btn btn-outline-purple">
        üîê Users
    </a>
    {% endif %}

    {% if user_role == "admin" or user_role == "superuser" %}
    <a href="{% url 'add_event' %}" class="qa-btn btn-outline-green">
        ‚ûï Add Event
    </a>

    <a href="{% url 'manage_events' %}" class="qa-btn btn-outline-blue">
        üõ†Ô∏è Events
    </a>
    {% endif %}

    <a href="{% url 'calendar' %}" class="qa-btn btn-outline-green">
        üìÖ Calendar
    </a>
    <a href="{% url 'map' %}" class="qa-btn btn-outline-blue">
        üó∫Ô∏è Map
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Top slide-down alert -->
<div id="top-alert" class="alert" role="alert" style="position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            z-index: 1050; width: auto; max-width: 400px; transition: top 0.5s ease, opacity 0.5s ease; opacity: 0;">
    <span id="top-alert-message"></span>
    <button type="button" class="close" onclick="hideAlert()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- ‚¨ÖÔ∏è Left Spacer -->
        <div class="col-12 col-md-1" style="max-width: 85px;"><!-- Empty column for spacing --></div>

        <!-- üß≠ Left Column -->
        <div class="col-12 col-md-2 pe-4">
            <h5 class="mb-3 filter-title">Filters</h5>

            <form id="filterForm" onsubmit="return false;">
                {% for field in form %}
                    <div class="filter-block">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold filter-category">{{ field.label }}</span>
                            <button class="btn btn-sm btn-outline-secondary toggle-btn" 
                                    type="button" 
                                    data-target="#{{ field.name }}Filter" 
                                    aria-expanded="false" 
                                    aria-controls="{{ field.name }}Filter">
                                +
                            </button>
                        </div>
                        
                        <div class="filter-content mt-2" id="{{ field.name }}Filter">
                            {% for checkbox in field %}
                                <label class="form-check filter-checkbox-label">
                                    <input 
                                        type="checkbox"
                                        name="{{ field.name }}"
                                        value="{{ checkbox.data.value }}"
                                        id="{{ checkbox.id_for_label }}"
                                        class="filter-checkbox"
                                        {% if checkbox.data.selected %}checked{% endif %}
                                    >
                                    {{ checkbox.choice_label }}
                                    <span class="checkmark"></span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </form>
        </div>

        <div class="col-12 col-md-1" style="max-width: 85px;"><!-- empty spacer --></div>

        <!-- üéüÔ∏è Middle Column -->
        <div class="col-12 col-md-8 ps-4">
            <!-- Short Description -->
            <div style="width: 100%;">
                <p style="font-weight: bold; font-style: italic; color: #003366; background-color: white; padding: 5px; margin: 0 0 15px 0; font-size: 125%;">
                    Diablo Valley College (DVC) hosts a diverse range of events that cater to the interests and needs of its vibrant student community. 
                    From academic workshops and career fairs to guest speaker sessions, DVC offers numerous opportunities for students to engage, learn, and connect. 
                    The college regularly features performances, art exhibits, and athletic events, ensuring there's always something exciting happening on campus.
                </p>
            </div>

            <!-- The Events Search Bar-->
            <div class="p-3 bg-white border rounded mb-3">
                <!-- Search form (functional with icon) -->
                <form method="get" action="{% url 'home' %}" class="d-flex align-items-center mb-3 w-100">
                    <div id="searchbar" class="w-100">
                        <input type="text" placeholder="Search Events">
                        <div id="search-icon" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 24 24" style="fill:#FFFFFF;">
                                <path d="M 10 2 C 5.5965257 2 2 5.5965291 2 10 C 2 14.403471 5.5965257 18 10 18 C 11.752132 18 13.370523 17.422074 14.691406 16.458984 L 20.224609 21.992188 L 21.992188 20.224609 L 16.458984 14.691406 C 17.422074 13.370523 18 11.75213 18 10 C 18 5.5965291 14.403474 2 10 2 z M 10 4.5 C 13.052375 4.5 15.5 6.947627 15.5 10 C 15.5 13.052373 13.052375 15.5 10 15.5 C 6.9476251 15.5 4.5 13.052373 4.5 10 C 4.5 6.947627 6.9476251 4.5 10 4.5 z"></path>
                            </svg>
                        </div>
                    </div>
                </form>

                <!-- ‚úÖ Events grid -->
                <div id="events-grid" class="row">
                    {% for event in events_data %}
                    <div class="col-md-6 mb-4">
                        {% include 'partials/event_card.html' with event=event user_favorites=user_favorites %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination Controls -->
                <div id="pagination" class="text-center mt-4">
                    <!-- Previous arrow -->
                    {% if events_data.has_previous %}
                        <a href="?page={{ events_data.previous_page_number }}" class="pagination-arrow">&lt;</a>
                    {% else %}
                        <span class="pagination-arrow disabled">&lt;</span>
                    {% endif %}

                    <!-- Page numbers -->
                    {% for num in events_data.paginator.page_range %}
                        {% if events_data.number == num %}
                            <span class="pagination-number active">{{ num }}</span>
                        {% else %}
                            <a href="?page={{ num }}" class="pagination-number">{{ num }}</a>
                        {% endif %}
                    {% endfor %}

                    <!-- Next arrow -->
                    {% if events_data.has_next %}
                        <a href="?page={{ events_data.next_page_number }}" class="pagination-arrow">&gt;</a>
                    {% else %}
                        <span class="pagination-arrow disabled">&gt;</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ‚¨ÖÔ∏è Right Spacer -->
        <div class="col-12 col-md-1"><!-- Empty column for spacing --></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

<script>
document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const target = document.querySelector(btn.dataset.target);
        if (!target) return;

        const isOpen = target.classList.contains('show');

        if (isOpen) {
            // Close
            target.style.height = target.scrollHeight + 'px';
            requestAnimationFrame(() => target.style.height = '0px');
            target.addEventListener('transitionend', function handler() {
                target.classList.remove('show');
                target.style.height = '';
                btn.textContent = '+'; // ‚úÖ Update button here
                target.removeEventListener('transitionend', handler);
            });
        } else {
            // Open
            target.classList.add('show');
            const height = target.scrollHeight;
            target.style.height = '0px';
            requestAnimationFrame(() => target.style.height = height + 'px');
            target.addEventListener('transitionend', function handler() {
                target.style.height = '';
                btn.textContent = '‚àí'; // ‚úÖ Update button here
                target.removeEventListener('transitionend', handler);
            });
        }
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.interested-btn');
        const alertDiv = document.getElementById('top-alert');
        const alertMessage = document.getElementById('top-alert-message');

        function showAlert(message, type = 'info') {
            alertDiv.className = `alert alert-${type}`;
            alertMessage.textContent = message;

            // Reset position instantly to hidden (no animation)
            alertDiv.style.transition = 'none';
            alertDiv.style.top = '-60px';
            alertDiv.style.opacity = '0';

            // Force browser to reflow so transition will work
            void alertDiv.offsetWidth;

            // Restore transition
            alertDiv.style.transition = 'top 0.5s ease, opacity 0.5s ease';

            // Slide down
            alertDiv.style.top = '20px';
            alertDiv.style.opacity = '1';

            // Clear any existing timer
            if (alertDiv.hideTimeout) {
                clearTimeout(alertDiv.hideTimeout);
            }

            // Auto-hide after 3 seconds
            alertDiv.hideTimeout = setTimeout(() => {
                hideAlert();
            }, 3000);
        }

        window.hideAlert = function () {
            alertDiv.style.top = '-60px';
            alertDiv.style.opacity = '0';
        };

        buttons.forEach(button => {
            button.addEventListener('click', async () => {
                const eventId = button.dataset.eventId;
                const csrfToken = '{{ csrf_token }}';

                try {
                    const response = await fetch(`/favorite/${eventId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.status === 'error') {
                        showAlert("‚ö†Ô∏è Please log in to mark an event as interested.", 'warning');
                        return;
                    }

                    if (data.status === 'added') {
                        button.textContent = 'Unmark ‚≠ê';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-success');
                        showAlert("‚≠ê Added to your interested events!", 'success');
                    } else if (data.status === 'removed') {
                        button.textContent = 'Interested ‚≠ê';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-warning');
                        showAlert("‚ùå Removed from your interested events.", 'info');
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("JS Loaded!");

    const buttons = document.querySelectorAll('.interested-btn');
    console.log("Found buttons:", buttons.length);
});
</script>

<script>
function showTopMessage(text, type = "info") {
    const box = document.getElementById("topNotification");

    const colors = {
        success: "#28a745",
        error: "#dc3545",
        warning: "#ffc107",
        info: "#17a2b8"
    };
    box.textContent = text;
    box.style.background = colors[type] || colors.info;

    // Reset instantly
    box.style.transition = "none";
    box.style.top = "-80px";
    box.style.opacity = "0";
    void box.offsetWidth; // force reflow

    // Apply transition
    box.style.transition = "top 0.5s ease, opacity 0.5s ease";

    // Tiny delay ensures smooth slide
    setTimeout(() => {
        box.style.top = "20px";
        box.style.opacity = "1";
    }, 50);

    // Auto-hide
    setTimeout(() => {
        box.style.top = "-80px";
        box.style.opacity = "0";
    }, 2600);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const filterForm = document.getElementById("filterForm");
    const searchInput = document.getElementById("search-input");

    // -----------------------------
    // Build params & fetch results
    // -----------------------------
    function applyFilters(page = null) {
        const params = new URLSearchParams();

        // all checked filters
        filterForm.querySelectorAll(".filter-checkbox:checked").forEach(cb => {
            params.append(cb.name, cb.value);
        });

        // search query
        if (searchInput && searchInput.value.trim()) {
            params.append("q", searchInput.value.trim());
        }

        // page number
        if (page) params.append("page", page);

        fetch("/?" + params.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(r => r.text())
            .then(html => {
                const doc = new DOMParser().parseFromString(html, "text/html");

                // update events grid
                const newGrid = doc.querySelector("#events-grid");
                const oldGrid = document.querySelector("#events-grid");
                if (newGrid && oldGrid) oldGrid.innerHTML = newGrid.innerHTML;

                // update pagination
                const newPag = doc.querySelector("#pagination");
                const oldPag = document.querySelector("#pagination");
                if (newPag && oldPag) oldPag.innerHTML = newPag.innerHTML;

                // re-bind pagination
                bindPaginationLinks();
            });
    }

    // -----------------------------
    // Checkbox change listener
    // -----------------------------
    filterForm.addEventListener("change", e => {
        if (e.target.classList.contains("filter-checkbox")) {
            applyFilters();
        }
    });

    // -----------------------------
    // Instant search (with delay)
    // -----------------------------
    let typingTimer;
    const typingDelay = 500; // ms

    if (searchInput) {
        searchInput.addEventListener("input", () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => applyFilters(), typingDelay);
        });
    }

    // -----------------------------
    // Pagination links
    // -----------------------------
    function bindPaginationLinks() {
        document.querySelectorAll("#pagination a.page-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                const page = link.getAttribute("href").split("page=")[1];
                applyFilters(page);
            });
        });
    }

    // Initial bind
    bindPaginationLinks();
});
</script>

{% for message in messages %}
<script>
showTopMessage("{{ message|escapejs }}", "{{ message.tags }}");
</script>
{% endfor %}
{% endblock %}